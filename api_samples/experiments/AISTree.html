<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>LayersTree</title>
<style>
* {
    color: #003366;
    font-family: sans-serif;
    font-size: 11px;
    margin: 0;
    padding: 0;
}
body {
    background-color: #FAFAFE;
    border: medium none;
    color: inherit;
    overflow: hidden;
}

#flash {
    width: 900px;
    margin-left: 50%;
}

#tree {
    /*position: absolute;*/
    width: 400px;
    height: 100%;
    float: left;
}

.box {
    float: left;
}

.invisible, .invisible span, .invisible div, tr td.invisible {
    color: #999999;
}

.groupInvisible {
    display: none;
}

.layer {
    cursor: pointer;
    padding: 0 2px 0 4px;
    position: relative;
}

.groupLayer {
    cursor: pointer;
    font-weight: bold;
    margin: 0 0 0 4px;
}

.swap {
    height: 5px;
}

.layerDescription {
    color: #7D7D8D;
    margin: 0 5px;
}

</style>
<link rel="stylesheet" type="text/css" media="screen" href="../data/css/treeview.css">
</head>
<body>
    <div id="tree"></div>
	<div id="table" style="width: 50px; float: left; vertical-align: top; cursor: pointer;"></div>
	<div id="shipImg" style="float: left; vertical-align: top; margin-left: 20px;"></div>
    <div id="flash" class="flashMap"></div>
    <script src="http://maps.kosmosnimki.ru/api/jquery/jquery-1.5.1.min.js"></script>
    <script src="http://maps.kosmosnimki.ru/api/jquery/jquery.treeview.js"></script>
	<script src="http://maps.kosmosnimki.ru/api/apil.js?key=U92596WMIH" charset=windows-1251></script>
    <script src="../data/FiresTree.js"></script>
    <script>
    var globalFlashMap;
    
    $(function() {
        createFlashMap($("#flash")[0], "maps.kosmosnimki.ru", "VCQ3R", function(map, tree) {
			map.moveTo(166.90979, 54.801138, 8);

			window.myLayer = null;
			window.showMMSI = function(mmsi, obj)
			{
				if(window.myLayer) {
					window.myLayer.setVisibilityFilter('"MMSI" = \'' + mmsi + '\'');
					for(var i=0, len=obj.parentNode.childNodes.length; i<len; i++) {			// Удаление слоя из массива
						var tObj = obj.parentNode.childNodes[i];
						if(tObj.style) tObj.style.color = "black";
					}
					obj.style.color = "red";
					var shipImg = document.getElementById("shipImg");
					var txt = '<img src="http://photos.marinetraffic.com/ais/showphoto.aspx?size=thumb&mmsi='+mmsi+'"/>';
					shipImg.innerHTML = txt;
				}
			}
				
			var getLastAISPosition = 'http://sender.kosmosnimki.ru/v3/DBWebProxy.ashx?Type=GetAISKMS';
			
			for(var i=0; i<map.layers.length; i++) {			// Удаление слоя из массива
				var layer = map.layers[i];
				var prop = layer.properties;
				if(prop.title.indexOf('exactEarth_') != -1) {
					layer.filters[0].enableHoverBalloon(function(item, div)
						{
							var geo = item.getGeometry();
							var point = geo.coordinates;
						
							var innerTemplate = "<table style='width:300px;'><tbody><tr><td vAlign=\"top\" style=\"width:150px;height: 100px;\">Корабль: <strong><br>"+item.properties['MMSI']+"</strong><br>Время: <strong><br>"+item.properties['Time']+"</strong><br>Координаты: <strong><br>"+gmxAPI.formatCoordinates(gmxAPI.merc_x(point[0]), gmxAPI.merc_y(point[1]))+"</strong></td><td vAlign=\"top\" style=\"width:150px;\"><img src=\"http://photos.marinetraffic.com/ais/showphoto.aspx?size=thumb&mmsi="+item.properties['MMSI']+"\"/></td></tr></tbody></table>";
							div.innerHTML = innerTemplate
							return {};
						}, {disableOnMouseOver: true});
				
					(function(player) {
						player.addListener('onChangeVisible', function(flag) {				// Изменилась видимость слоя
							var table = document.getElementById("table");
							if(flag) {
								window.myLayer = player;
								window.myLayer.setVisibilityFilter('');

								var prepareAIS = function(arr)
								{
									var out = [];
									for(var i=0; i<arr.length; i++) {
										var item = arr[i];
										var mmsi = item[0];
										//items[mmsi] = item;
										out.push('<li onclick="showMMSI('+mmsi+', this);">'+mmsi+'</li>');
									}
									var st = out.join('\n');
									table.innerHTML = '<ol>'+st+'</ol>';
								}

								var psrc = getLastAISPosition + '&Name=' + window.myLayer.properties.name;
								gmxAPI.sendCrossDomainJSONRequest(psrc, function(response)
								{
									if(typeof(response) != 'object' || response['Result'] != 'Ok') {
										alert('Error in: ' + psrc);
										return;
									}
									prepareAIS(response['Response']);
								});
							} else {
								table.innerHTML = '';
								window.myLayer = null;
							}
						}, -10);
					})(layer);
				}
			}
			
            globalFlashMap = map;
                
            var firesTree = new FiresTree();

            // рисуем все дерево
            firesTree.drawTree(tree, $("#tree"));
            
            // либо находим нужную группу
            // firesTree.drawGroup(firesTree.findGroup(tree, "1f16ac99619b4cdf"), $("#tree"));
            
            // либо находим нужный слой
            // firesTree.drawLayer(firesTree.findLayer(tree, "18775"), $("#tree"));
            
            // либо создаем новую группу 
            /*var group = {
                    content: {
                        properties: {
                            title: "Новая группа",
                            GroupID: "1",
                            visible: true
                        },
                        children: [
                            firesTree.findLayer(tree, "789213E1F02C4BF48217319A84F519C6"),
                            firesTree.findLayer(tree, "DDFD45A36BF44364B3C8391D3B8EB50C"),
                            firesTree.findLayer(tree, "3B54CAC1C54345B3B93D49876A4C5C53")
                        ]
                    }
                };
            
            firesTree.drawGroup(group, $("#tree"));*/
			//firesTree.drawGroup(firesTree.findGroup(tree, "9vePb9U5BbByGsf9"), $("#tree"));
        });        
    });
    </script>
</body>
</html>